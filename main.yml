---
- hosts: localhost
  gather_facts: no

  tasks:

  - name: Get credentials from vault
    include_vars:
      file: password.yml
      name: vault

  - name: set variables
    set_fact:
      hostname: jenkins
      key_file_path: "{{ playbook_dir }}/{{ vault['aws_key_name']}}.pem" 
      py_path: /usr/bin/python 

  - name: Create pem file
    copy:
      content: "{{ vault['aws_key']}}"
      dest: "{{ key_file_path }}"
      force: yes
      mode: 0400

  - name: Install pip dependency
    pip:
      name: boto
      state: present

  - import_tasks: create_ec2.yaml   

- hosts: jenkins
  gather_facts: no
  become: yes
  
  pre_tasks:
  
  - name: 'Install python2'
    raw: sudo apt -y update && sudo apt -y install python-simplejson

  tasks:

  - name: Get credentials
    include_vars:
      file: password.yml
      name: vault

  - name: Update packages
    apt:
      update_cache: yes
      upgrade: dist

  - import_tasks: install_dependencies.yaml
  
  - import_tasks: configure_jenkins.yaml

  - name: Wait for Jenkins
    shell: "curl -D - --silent --max-time 5 http://localhost:8080/cli/"
    register: result
    until: (result.stdout.find("403 Forbidden") != -1) or (result.stdout.find("200 OK") != -1) and (result.stdout.find("Please wait while") == -1)
    retries: 5
    delay: 5
    changed_when: false
  
  - import_tasks: copy_files.yaml

  - import_tasks: checkbox_job.yaml
  
  - import_tasks: itrust_job.yaml
